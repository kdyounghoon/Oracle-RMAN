<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<ns2:workflow xmlns:ns2="http://vmware.com/vco/workflow" root-name="item13" object-name="workflow:name=generic" id="f8cd5692-92a0-46b6-a98d-53ffd878d779" editor-version="1.6" version="0.1.4" api-version="6.0.0" allowed-operations="evf" restartMode="1" resumeFromFailedMode="0">
    <display-name>Run Script In Guest</display-name>
    <description>Run a script inside the VM and wait until it returns his result.
Retrieve the output of the script and returns it as output in the workflow

Inspired by implementation done in PowerCLI in the following .NET class :
- VMware.VimAutomation.ViCore.Impl.V1.RunScriptInGuestHelper
- VMware.VimAutomation.ViCore.Impl.V1.Service.VmGuestServiceImpl

Requires running VMwareTools instance in the GuestOS.
Leverages the vSphere 5.x GuestOperationsManager object and is not backwards compatible with previous versions of vSphere.</description>
    <position y="18.136363636363633" x="45.0"/>
    <input>
        <param name="vm" type="VC:VirtualMachine">
            <description>Virtual Machine (VC)</description>
        </param>
        <param name="username" type="string">
            <description>Guest OS username</description>
        </param>
        <param name="password" type="SecureString">
            <description>Guest OS password</description>
        </param>
        <param name="scriptType" type="string">
            <description>bash / bat / powershell</description>
        </param>
        <param name="script" type="string">
            <description>Script Text</description>
        </param>
        <param name="scriptTimeout" type="number">
            <description>Timeout for the running script (in second)</description>
        </param>
        <param name="scriptRefreshTime" type="number">
            <description>(default) Time (in seconds) where a check of script status occurs</description>
        </param>
        <param name="scriptWorkingDirectory" type="string">
            <description>Script working directory in the guest</description>
        </param>
        <param name="interactiveSession" type="boolean">
            <description>Script context interactivity</description>
        </param>
    </input>
    <output>
        <param name="scriptOutputText" type="string">
            <description>Output of the script</description>
        </param>
        <param name="scriptExitCode" type="number">
            <description>Exit code of the script</description>
        </param>
    </output>
    <attrib name="errorMessage" type="string">
        <value encoded="n"></value>
        <description>(internal) Error Message</description>
    </attrib>
    <attrib name="scriptArguments" type="string">
        <value encoded="n"></value>
        <description>(internal) Script arguments</description>
    </attrib>
    <attrib name="scriptProgramPath" type="string">
        <value encoded="n"></value>
        <description>(internal) Path to the scripting process</description>
    </attrib>
    <attrib name="scriptPid" type="number">
        <value encoded="n"/>
        <description>(internal) Pid of the script cmd in the guest</description>
    </attrib>
    <attrib name="scriptProcessInfo" type="Array/CompositeType(pid:number,name:string,owner:string,cmdLine:string,startTime:Date,endTime:Date,exitCode:number):GuestProcessInfoType">
        <value encoded="n"/>
        <description>(internal) List of running processes in the guest</description>
    </attrib>
    <attrib name="scriptFinished" type="boolean">
        <value encoded="n">false</value>
        <description>(internal) Flag when script is finished</description>
    </attrib>
    <attrib name="scriptTimeoutCounter" type="number">
        <value encoded="n">0.0</value>
        <description>(internal) Counter for timeout</description>
    </attrib>
    <attrib name="scriptOutputFile" type="string">
        <value encoded="n"></value>
        <description>(internal) File path where the script output will be written in the guest</description>
    </attrib>
    <attrib name="scriptOutputPrefix" type="string">
        <value encoded="n">vco_</value>
        <description>(default) The prefix to be given to the new temporary file</description>
    </attrib>
    <attrib name="vcoCopiedFileResult" type="boolean">
        <value encoded="n">false</value>
        <description>(internal) True if copy operation was successful</description>
    </attrib>
    <attrib name="vcoTempFile" type="string">
        <value encoded="n"></value>
        <description>(internal) vCO server temporary file path</description>
    </attrib>
    <attrib name="cmdAnsi" type="ResourceElement">
        <value encoded="n">dunes://service.dunes.ch/ResourceElement?id='352d998c-6af5-4af9-8c4f-da4a2a2dff2b'&amp;dunesName='ResourceElement'</value>
        <description>Redirects cmd output to ANSI. Thanks to Pierre Torris www.ptorris.com</description>
    </attrib>
    <attrib name="cmdAnsiVcoPath" type="string">
        <value encoded="n"></value>
    </attrib>
    <attrib name="cmdAnsiGuestPath" type="string">
        <value encoded="n"></value>
        <description>Guest file path</description>
    </attrib>
    <attrib name="overwrite" type="boolean">
        <value encoded="n">true</value>
        <description>Overwrite file if exists</description>
    </attrib>
    <attrib name="useCmdAnsi" type="boolean">
        <value encoded="n">true</value>
    </attrib>
    <attrib name="powershellScriptGuestPath" type="string">
        <value encoded="n"></value>
        <description>The absolute path of the temporary file that is created.</description>
    </attrib>
    <attrib name="powershellScript" type="string">
        <value encoded="n"></value>
    </attrib>
    <attrib name="powershellScriptVcoPath" type="string">
        <value encoded="n"></value>
    </attrib>
    <attrib name="powershellSuffix" type="string">
        <value encoded="n">.ps1</value>
        <description>The suffix to be given to the new temporary file</description>
    </attrib>
    <attrib name="errorCode" type="string">
        <value encoded="n"></value>
    </attrib>
    <attrib name="guestTempDirectory" type="string">
        <value encoded="n"></value>
        <description>The absolute path of the temporary directory that is created.</description>
    </attrib>
    <attrib name="recirsive" type="boolean">
        <value encoded="n">true</value>
        <description>Delete directory content recursively</description>
    </attrib>
    <attrib name="delay" type="number">
        <value encoded="n"/>
        <description>Time to wait (seconds)</description>
    </attrib>
    <workflow-item name="item6" out-name="item31" catch-name="item38" throw-bind-name="errorCode" type="task" comparator="0">
        <display-name>Delete file in vCO server</display-name>
        <script encoded="false">try {
	var file = new File(vcoTempFile);
	if(file.exists)
	{	
		file.deleteFile();
	}
} catch(err) {
	System.warn("Error during deletion of the temporary file in guest OS ("+vcoTempFile+") :\n" + err);
}</script>
        <in-binding>
            <bind name="vcoTempFile" type="string" export-name="vcoTempFile"/>
        </in-binding>
        <out-binding/>
        <position y="273.59090909090907" x="1524.5"/>
    </workflow-item>
    <workflow-item name="item3" out-name="item21" alt-out-name="item15" type="custom-condition" comparator="0">
        <display-name>Bash Script?</display-name>
        <script encoded="false">if(scriptType.toLowerCase() == "bash") return true;
return false;</script>
        <in-binding>
            <bind name="scriptType" type="string" export-name="scriptType"/>
        </in-binding>
        <position y="18.136363636363633" x="544.5"/>
    </workflow-item>
    <workflow-item name="item7" out-name="item32" type="task" comparator="0">
        <display-name>set for Bat</display-name>
        <script encoded="false">
scriptProgramPath = "cmd.exe";

//script = script.replace("\r\n", " &amp; ");
//script = script.replace("\n", " &amp; ");

script = script.replace(new RegExp("\r\n", 'g'), " &amp; ");
script = script.replace(new RegExp("\n", 'g'), " &amp; ");

script = "\"" + script + "\"";
scriptArguments = "/s /c cmd &gt;" + scriptOutputFile + " 2&gt;&amp;1 /s /c " + script;
//scriptArguments = "/s /c " + script + " 2&gt;&amp;1 | cmdansi " + scriptOutputFile;
</script>
        <in-binding>
            <bind name="script" type="string" export-name="script"/>
            <bind name="scriptOutputFile" type="string" export-name="scriptOutputFile"/>
        </in-binding>
        <out-binding>
            <bind name="scriptArguments" type="string" export-name="scriptArguments"/>
            <bind name="scriptProgramPath" type="string" export-name="scriptProgramPath"/>
        </out-binding>
        <description>Use the same implementation as used in PowerCLI
(VMware.VimAutomation.ViCore.Impl.V1.RunScriptInGuestHelper)</description>
        <position y="91.77272727272727" x="684.5"/>
    </workflow-item>
    <workflow-item name="item5" throw-bind-name="errorCode" type="end" end-mode="1" comparator="0">
        <position y="199.95454545454544" x="1564.5"/>
    </workflow-item>
    <workflow-item name="item13" out-name="item41" alt-out-name="item19" type="custom-condition" comparator="0">
        <display-name>isToolsOk ?</display-name>
        <script encoded="false">return System.getModule("com.vmware.pso.GuestOps").testVmToolsForGuestOps(vm);</script>
        <in-binding>
            <bind name="vm" type="VC:VirtualMachine" export-name="vm"/>
        </in-binding>
        <out-binding/>
        <position y="18.136363636363633" x="125.0"/>
    </workflow-item>
    <workflow-item name="item14" out-name="item10" alt-out-name="item18" type="condition" comparator="0">
        <display-name>isFinished ?</display-name>
        <script encoded="false">//Generated by the system, cannot be edited
return (scriptFinished == true) ;</script>
        <in-binding>
            <bind name="scriptFinished" type="boolean" export-name="scriptFinished"/>
        </in-binding>
        <condition name="scriptFinished" type="boolean" comparator="0" label="null">false</condition>
        <position y="199.95454545454544" x="1804.5"/>
    </workflow-item>
    <workflow-item name="item16" out-name="item14" catch-name="item5" throw-bind-name="errorCode" type="task" comparator="0">
        <display-name>Check script state</display-name>
        <script encoded="false">if(scriptProcessInfo &amp;&amp; scriptProcessInfo.length &gt; 0)
{
	for each(var guestProcessInfo in scriptProcessInfo)
	{		
		if(guestProcessInfo.pid == scriptPid)
		{
			if (System.getObjectType(guestProcessInfo.exitCode) != null)
			{
				scriptExitCode = guestProcessInfo.exitCode;
				scriptFinished = true;
			}
			break;
		}
	}
}
else
{
	throw "Process not found";
}
</script>
        <in-binding>
            <bind name="scriptProcessInfo" type="Array/CompositeType(pid:number,name:string,owner:string,cmdLine:string,startTime:Date,endTime:Date,exitCode:number):GuestProcessInfoType" export-name="scriptProcessInfo"/>
            <bind name="scriptPid" type="number" export-name="scriptPid"/>
        </in-binding>
        <out-binding>
            <bind name="scriptFinished" type="boolean" export-name="scriptFinished"/>
            <bind name="scriptExitCode" type="number" export-name="scriptExitCode"/>
        </out-binding>
        <position y="209.95454545454544" x="1664.5"/>
    </workflow-item>
    <workflow-item name="item18" out-name="item11" alt-out-name="item2" type="custom-condition" comparator="0">
        <display-name>Timeout ?</display-name>
        <script encoded="false">return (scriptTimeout &gt; scriptTimeoutCounter*scriptRefreshTime)</script>
        <in-binding>
            <bind name="scriptTimeoutCounter" type="number" export-name="scriptTimeoutCounter"/>
            <bind name="scriptTimeout" type="number" export-name="scriptTimeout"/>
            <bind name="scriptRefreshTime" type="number" export-name="scriptRefreshTime"/>
        </in-binding>
        <position y="18.136363636363633" x="1804.5"/>
    </workflow-item>
    <workflow-item name="item21" out-name="item0" type="task" comparator="0">
        <display-name>set for Linux</display-name>
        <script encoded="false">
scriptProgramPath = "/bin/bash";

script = script.replace("\r\n", " ; ");
script = script.replace("\\\"", "'\"'");
script = script.replace(/\"/g, "\\\\\\\"");
scriptArguments = "-c \"bash &gt; " + scriptOutputFile + " 2&gt;&amp;1 -c \\\"" + script + "\\\"\"";
useCmdAnsi = false;</script>
        <in-binding>
            <bind name="script" type="string" export-name="script"/>
            <bind name="scriptOutputFile" type="string" export-name="scriptOutputFile"/>
        </in-binding>
        <out-binding>
            <bind name="scriptArguments" type="string" export-name="scriptArguments"/>
            <bind name="scriptProgramPath" type="string" export-name="scriptProgramPath"/>
            <bind name="useCmdAnsi" type="boolean" export-name="useCmdAnsi"/>
        </out-binding>
        <description>Use the same implementation as used in PowerCLI
(VMware.VimAutomation.ViCore.Impl.V1.RunScriptInGuestHelper)</description>
        <position y="28.136363636363633" x="1384.5"/>
    </workflow-item>
    <workflow-item name="item11" out-name="item37" type="task" comparator="0">
        <display-name>Sleep / Count</display-name>
        <script encoded="false">//Sleep
if ( scriptRefreshTime == null )  {
	delay = 5;
} else {
	delay = scriptRefreshTime;
}

//Measure timeout
scriptTimeoutCounter++;
</script>
        <in-binding>
            <bind name="scriptRefreshTime" type="number" export-name="scriptRefreshTime"/>
            <bind name="scriptTimeoutCounter" type="number" export-name="scriptTimeoutCounter"/>
        </in-binding>
        <out-binding>
            <bind name="scriptTimeoutCounter" type="number" export-name="scriptTimeoutCounter"/>
            <bind name="delay" type="number" export-name="delay"/>
        </out-binding>
        <position y="28.136363636363633" x="1663.5"/>
    </workflow-item>
    <workflow-item name="item17" out-name="item3" catch-name="item33" throw-bind-name="errorMessage" type="link" business-status="Create temporary file in guest" linked-workflow-id="C9808080808080808080808080808080DA80808001322751030482b80adf61e7c" comparator="0">
        <display-name>Make Temp File in VM</display-name>
        <in-binding>
            <bind name="vmUsername" type="string" export-name="username">
                <description>Username for the virtual machine</description>
            </bind>
            <bind name="vmPassword" type="SecureString" export-name="password">
                <description>Password for the virtual machine</description>
            </bind>
            <bind name="vm" type="VC:VirtualMachine" export-name="vm">
                <description>Virtual machine</description>
            </bind>
            <bind name="dirPath" type="string" export-name="guestTempDirectory">
                <description>The complete path to the directory in which to create the new file. If unset or an empty string, a guest-specific location will be used.</description>
            </bind>
            <bind name="prefix" type="string" export-name="scriptOutputPrefix">
                <description>The prefix to be given to the new temporary file</description>
            </bind>
            <bind name="suffix" type="string">
                <description>The suffix to be given to the new temporary file</description>
            </bind>
        </in-binding>
        <out-binding>
            <bind name="result" type="string" export-name="scriptOutputFile">
                <description>The absolute path of the temporary file that is created.</description>
            </bind>
        </out-binding>
        <description>Create a temporary file in a guest virtual machine.</description>
        <position y="28.136363636363633" x="404.5"/>
    </workflow-item>
    <workflow-item name="item0" out-name="item11" type="link" linked-workflow-id="C98080808080808080808080808080805E80808001322751030482b80adf61e7c" comparator="0">
        <display-name>Start Script</display-name>
        <in-binding>
            <bind name="vmUsername" type="string" export-name="username">
                <description>Username for the virtual machine</description>
            </bind>
            <bind name="vmPassword" type="SecureString" export-name="password">
                <description>Password for the virtual machine</description>
            </bind>
            <bind name="vm" type="VC:VirtualMachine" export-name="vm">
                <description>Virtual machine</description>
            </bind>
            <bind name="interactiveSession" type="boolean" export-name="interactiveSession">
                <description>This is set to true if the client wants an interactive session in the guest.</description>
            </bind>
            <bind name="programPath" type="string" export-name="scriptProgramPath">
                <description>The absolute path to the program to start. For Linux guest operating systems, /bin/bash is used to start the program.  For Solaris guest operating systems, /bin/bash is used to start the program if it exists. Otherwise /bin/sh is used. If /bin/sh is used, then the process ID returned will be that of the shell used to start the program, rather than the program itself, due to the differences in how /bin/sh and /bin/bash work. This PID will still be usable for watching the process with this API to find its exit code and elapsed time. </description>
            </bind>
            <bind name="arguments" type="string" export-name="scriptArguments">
                <description>The arguments to the program. In Linux and Solaris guest operating systems, the program will be executed by a guest shell. This allows stdio redirection, but may also require that characters which must be escaped to the shell also be escaped on the command line provided. For Windows guest operating systems, prefixing the command with "cmd /c" can provide stdio redirection. </description>
            </bind>
            <bind name="workingDirectory" type="string" export-name="scriptWorkingDirectory">
                <description>The absolute path of the working directory for the program to be run. VMware recommends explicitly setting the working directory for the program to be run. If this value is unset or is an empty string, the behavior depends on the guest operating system. For Linux guest operating systems, if this value is unset or is an empty string, the working directory will be the home directory of the user associated with the guest authentication. For other guest operating systems, if this value is unset, the behavior is unspecified. </description>
            </bind>
            <bind name="environment" type="Array/Any" export-name="NULL">
                <description>An array of environment variables, specified in the guest OS notation (eg PATH=c:\bin;c:\windows\system32 or LD_LIBRARY_PATH=/usr/lib:/lib), to be set for the program being run. Note that these are not additions to the default environment variables; they define the complete set available to the program. If none are specified the values are guest dependent. </description>
            </bind>
        </in-binding>
        <out-binding>
            <bind name="result" type="number" export-name="scriptPid">
                <description>The pid of the program started.</description>
            </bind>
        </out-binding>
        <description>Starts a program in the guest operating system.
A process started this way can have its status queried with this API. When the process completes, its exit code and end time will be available for 5 minutes after completion.</description>
        <position y="28.136363636363633" x="1524.5"/>
    </workflow-item>
    <workflow-item name="item1" out-name="item16" catch-name="item40" throw-bind-name="errorCode" type="link" linked-workflow-id="C98080808080808080808080808080800180808001322751030482b80adf61e7c" comparator="0">
        <display-name>Get Processes</display-name>
        <in-binding>
            <bind name="vmUsername" type="string" export-name="username">
                <description>Username for the virtual machine</description>
            </bind>
            <bind name="vmPassword" type="SecureString" export-name="password">
                <description>Password for the virtual machine</description>
            </bind>
            <bind name="vm" type="VC:VirtualMachine" export-name="vm">
                <description>Virtual machine</description>
            </bind>
        </in-binding>
        <out-binding>
            <bind name="result" type="Array/CompositeType(pid:number,name:string,owner:string,cmdLine:string,startTime:Date,endTime:Date,exitCode:number):GuestProcessInfoType" export-name="scriptProcessInfo">
                <description>The list running processes.</description>
            </bind>
        </out-binding>
        <description>List the processes running in the guest operating system, plus those started by this API that have recently completed</description>
        <position y="155.4090909090909" x="1664.5"/>
    </workflow-item>
    <workflow-item name="item4" out-name="item12" type="link" linked-workflow-id="C3808080808080808080808080808080ED80808001322751030482b80adf61e7c" comparator="0">
        <display-name>Copy output file</display-name>
        <in-binding>
            <bind name="vmUsername" type="string" export-name="username">
                <description>Username for the virtual machine</description>
            </bind>
            <bind name="vmPassword" type="SecureString" export-name="password">
                <description>Password for the virtual machine</description>
            </bind>
            <bind name="vm" type="VC:VirtualMachine" export-name="vm">
                <description>Virtual machine</description>
            </bind>
            <bind name="guestFilePath" type="string" export-name="scriptOutputFile">
                <description>Guest file path</description>
            </bind>
            <bind name="vcoPath" type="string" export-name="vcoTempFile">
                <description>Path on vCO server</description>
            </bind>
        </in-binding>
        <out-binding>
            <bind name="result" type="boolean" export-name="vcoCopiedFileResult">
                <description>Set to true if copy operation was successful</description>
            </bind>
        </out-binding>
        <description>Copies the specified file from the guest filesystem to the vCO server.</description>
        <position y="273.59090909090907" x="1804.5"/>
    </workflow-item>
    <workflow-item name="item2" out-name="item24" type="link" linked-workflow-id="C98080808080808080808080808080807B80808001322751030482b80adf61e7c" comparator="0">
        <display-name>Kill Script</display-name>
        <in-binding>
            <bind name="vmUsername" type="string" export-name="username">
                <description>Username for the virtual machine</description>
            </bind>
            <bind name="vmPassword" type="SecureString" export-name="password">
                <description>Password for the virtual machine</description>
            </bind>
            <bind name="vm" type="VC:VirtualMachine" export-name="vm">
                <description>Virtual machine</description>
            </bind>
            <bind name="pid" type="number" export-name="scriptPid">
                <description>Process ID of the process to be terminated </description>
            </bind>
        </in-binding>
        <out-binding/>
        <description>Terminates a process in the guest OS.</description>
        <position y="28.136363636363633" x="1944.5"/>
    </workflow-item>
    <workflow-item name="item12" out-name="item6" type="task" comparator="0">
        <display-name>Read output file</display-name>
        <script encoded="false">var fr = new FileReader(vcoTempFile);
if(fr.exists)
{
	fr.open();
	scriptOutputText = fr.readAll();
	System.log(scriptOutputText);
}
else
{
	scriptOutputText = "error: no output"
}

fr.close();</script>
        <in-binding>
            <bind name="vcoTempFile" type="string" export-name="vcoTempFile"/>
        </in-binding>
        <out-binding>
            <bind name="scriptOutputText" type="string" export-name="scriptOutputText"/>
        </out-binding>
        <position y="273.59090909090907" x="1663.5"/>
    </workflow-item>
    <workflow-item name="item15" out-name="item7" alt-out-name="item20" type="custom-condition" comparator="0">
        <display-name>Batch script?</display-name>
        <script encoded="false">if(scriptType.toLowerCase() == "batch" || scriptType.toLowerCase() == "bat") return true;
return false;</script>
        <in-binding>
            <bind name="scriptType" type="string" export-name="scriptType"/>
        </in-binding>
        <position y="81.77272727272727" x="544.5"/>
    </workflow-item>
    <workflow-item name="item20" out-name="item34" alt-out-name="item22" type="custom-condition" comparator="0">
        <display-name>Powershell script?</display-name>
        <script encoded="false">if(scriptType.toLowerCase() == "powershell") return true;
return false;</script>
        <in-binding>
            <bind name="scriptType" type="string" export-name="scriptType"/>
        </in-binding>
        <position y="145.4090909090909" x="544.5"/>
    </workflow-item>
    <workflow-item name="item19" out-name="item33" type="task" comparator="0">
        <display-name>Error Message</display-name>
        <script encoded="false">errorMessage = "VMware Tools are not running"</script>
        <in-binding/>
        <out-binding>
            <bind name="errorMessage" type="string" export-name="errorMessage"/>
        </out-binding>
        <position y="219.04545454545453" x="125.0"/>
    </workflow-item>
    <workflow-item name="item22" out-name="item33" type="task" comparator="0">
        <display-name>Error Message</display-name>
        <script encoded="false">errorMessage = "Script Type doesn't match with 'batch' / 'powershell' / 'bash'"</script>
        <in-binding/>
        <out-binding>
            <bind name="errorMessage" type="string" export-name="errorMessage"/>
        </out-binding>
        <position y="219.04545454545453" x="544.5"/>
    </workflow-item>
    <workflow-item name="item23" out-name="item36" type="task" comparator="0">
        <display-name>set for Powershell</display-name>
        <script encoded="false">
scriptProgramPath = "cmd.exe";

var s = "powershell.exe -OutputFormat text -NonInteractive -Command '&amp; {"+script+"}; exit $lastexitcode' &gt; \""+scriptOutputFile+"\"; exit $lastexitcode"

var trap = "trap" + "\n" + "{" + "\n" + "	Write-Error $_" + "\n" + "    exit 1" + "\n" + "}"+ "\n";
powershellScript = trap + script;



System.error(powershellScript);

//need to be encoded in unicode (UTF-16LE, double-byte) base64
//scriptArguments = "/C powershell -NonInteractive -EncodedCommand " + System.getModule("com.vmware.pso.util").encodeBase64Unicode2(s);// + " | cmdansi " + scriptOutputFile;

//Future : Need to change interactive below based on choice made in script config
scriptArguments = "/C powershell -OutputFormat text -NoProfile -NonInteractive -ExecutionPolicy unrestricted -f " + powershellScriptPath + " &gt; \""+scriptOutputFile+"\"";
System.error(scriptArguments);</script>
        <in-binding>
            <bind name="script" type="string" export-name="script"/>
            <bind name="scriptOutputFile" type="string" export-name="scriptOutputFile"/>
            <bind name="powershellScriptPath" type="string" export-name="powershellScriptGuestPath"/>
        </in-binding>
        <out-binding>
            <bind name="scriptArguments" type="string" export-name="scriptArguments"/>
            <bind name="scriptProgramPath" type="string" export-name="scriptProgramPath"/>
            <bind name="powershellScript" type="string" export-name="powershellScript"/>
        </out-binding>
        <description>Use the same implementation as used in PowerCLI
(VMware.VimAutomation.ViCore.Impl.V1.RunScriptInGuestHelper)</description>
        <position y="155.4090909090909" x="824.5"/>
    </workflow-item>
    <workflow-item name="item24" out-name="item10" type="task" comparator="0">
        <display-name>log message</display-name>
        <script encoded="false">System.warn("Script timeout - process has been killed");</script>
        <in-binding/>
        <out-binding/>
        <position y="82.68181818181817" x="1944.5"/>
    </workflow-item>
    <workflow-item name="item10" out-name="item26" type="task" comparator="0">
        <display-name>Create Temp File</display-name>
        <script encoded="false">var tempFilename = "vcoGuest_" + System.nextUUID();
var tempDirectory = System.getTempDirectory();
vcoTempFile = System.appendToPath(tempDirectory , tempFilename);</script>
        <in-binding/>
        <out-binding>
            <bind name="vcoTempFile" type="string" export-name="vcoTempFile"/>
        </out-binding>
        <description>Create temporary file on vCO server</description>
        <position y="209.95454545454544" x="1944.5"/>
    </workflow-item>
    <workflow-item name="item28" out-name="item0" type="link" linked-workflow-id="C78080808080808080808080808080809480808001322751030482b80adf61e7c" comparator="0">
        <display-name>Copy cmdAnsi to VM</display-name>
        <in-binding>
            <bind name="vmUsername" type="string" export-name="username">
                <description>Username for the virtual machine</description>
            </bind>
            <bind name="vmPassword" type="SecureString" export-name="password">
                <description>Password for the virtual machine</description>
            </bind>
            <bind name="vm" type="VC:VirtualMachine" export-name="vm">
                <description>Virtual machine</description>
            </bind>
            <bind name="vcoPath" type="string" export-name="cmdAnsiVcoPath">
                <description>Path on vCO server</description>
            </bind>
            <bind name="guestFilePath" type="string" export-name="cmdAnsiGuestPath">
                <description>Guest file path</description>
            </bind>
            <bind name="overwrite" type="boolean" export-name="overwrite">
                <description>Overwrite file if exists</description>
            </bind>
        </in-binding>
        <out-binding>
            <bind name="result" type="boolean" export-name="vcoCopiedFileResult">
                <description>Set to true if copy operation was successful</description>
            </bind>
        </out-binding>
        <description>Copy cmdAnsi from vCO to guest</description>
        <position y="91.77272727272727" x="1384.5"/>
    </workflow-item>
    <workflow-item name="item30" out-name="item28" type="task" comparator="0">
        <display-name>Save cmdAnsi to vCO</display-name>
        <script encoded="false">var cmdAnsiVcoPath = System.getTempDirectory() + "/" + cmdAnsi.name;

var cmdAnsiFile = new File(cmdAnsiVcoPath);

if (cmdAnsiFile.exists == true) {
	System.log(cmdAnsi.name + " already exist on vCO server : " + cmdAnsiVcoPath);
	}
else {	
	System.log("Writing resource to vCO server : " + cmdAnsiVcoPath);
	cmdAnsi.writeContentToFile(cmdAnsiVcoPath);
}</script>
        <in-binding>
            <bind name="cmdAnsi" type="ResourceElement" export-name="cmdAnsi"/>
        </in-binding>
        <out-binding>
            <bind name="cmdAnsiVcoPath" type="string" export-name="cmdAnsiVcoPath"/>
        </out-binding>
        <description>Write cmdAnsi.exe to vCO filesystem</description>
        <position y="91.77272727272727" x="1244.5"/>
    </workflow-item>
    <workflow-item name="item32" out-name="item30" type="task" comparator="0">
        <display-name>Path for cmdAnsi</display-name>
        <script encoded="false">cmdAnsiGuestPath = guestTempDirectory+"\\"+cmdAnsi.name;</script>
        <in-binding>
            <bind name="cmdAnsi" type="ResourceElement" export-name="cmdAnsi"/>
            <bind name="guestTempDirectory" type="string" export-name="guestTempDirectory"/>
        </in-binding>
        <out-binding>
            <bind name="cmdAnsiGuestPath" type="string" export-name="cmdAnsiGuestPath"/>
        </out-binding>
        <position y="91.77272727272727" x="1104.5"/>
    </workflow-item>
    <workflow-item name="item33" throw-bind-name="errorMessage" type="end" end-mode="1" comparator="0">
        <position y="209.04545454545453" x="384.5"/>
    </workflow-item>
    <workflow-item name="item26" out-name="item27" alt-out-name="item4" type="condition" comparator="0">
        <display-name>Convert ANSI chars?</display-name>
        <script encoded="false">//Generated by the system, cannot be edited
return (useCmdAnsi == true) ;</script>
        <in-binding>
            <bind name="useCmdAnsi" type="boolean" export-name="useCmdAnsi"/>
        </in-binding>
        <condition name="useCmdAnsi" type="boolean" comparator="0" label="null">false</condition>
        <position y="263.59090909090907" x="1944.5"/>
    </workflow-item>
    <workflow-item name="item27" out-name="item29" type="task" comparator="0">
        <display-name>Set ansi cmd</display-name>
        <script encoded="false">scriptProgramPath = "cmd.exe";
scriptArguments = "/A /C type " + scriptOutputFile + " | cmdansi " + scriptOutputFile;</script>
        <in-binding>
            <bind name="scriptOutputFile" type="string" export-name="scriptOutputFile"/>
        </in-binding>
        <out-binding>
            <bind name="scriptArguments" type="string" export-name="scriptArguments"/>
            <bind name="scriptProgramPath" type="string" export-name="scriptProgramPath"/>
        </out-binding>
        <position y="337.2272727272727" x="1944.5"/>
    </workflow-item>
    <workflow-item name="item29" out-name="item4" type="link" linked-workflow-id="C98080808080808080808080808080805E80808001322751030482b80adf61e7c" comparator="0">
        <display-name>Convert ANSI Output</display-name>
        <in-binding>
            <bind name="vmUsername" type="string" export-name="username">
                <description>Username for the virtual machine</description>
            </bind>
            <bind name="vmPassword" type="SecureString" export-name="password">
                <description>Password for the virtual machine</description>
            </bind>
            <bind name="vm" type="VC:VirtualMachine" export-name="vm">
                <description>Virtual machine</description>
            </bind>
            <bind name="interactiveSession" type="boolean" export-name="interactiveSession">
                <description>This is set to true if the client wants an interactive session in the guest.</description>
            </bind>
            <bind name="programPath" type="string" export-name="scriptProgramPath">
                <description>The absolute path to the program to start. For Linux guest operating systems, /bin/bash is used to start the program.  For Solaris guest operating systems, /bin/bash is used to start the program if it exists. Otherwise /bin/sh is used. If /bin/sh is used, then the process ID returned will be that of the shell used to start the program, rather than the program itself, due to the differences in how /bin/sh and /bin/bash work. This PID will still be usable for watching the process with this API to find its exit code and elapsed time. </description>
            </bind>
            <bind name="arguments" type="string" export-name="scriptArguments">
                <description>The arguments to the program. In Linux and Solaris guest operating systems, the program will be executed by a guest shell. This allows stdio redirection, but may also require that characters which must be escaped to the shell also be escaped on the command line provided. For Windows guest operating systems, prefixing the command with "cmd /c" can provide stdio redirection. </description>
            </bind>
            <bind name="workingDirectory" type="string" export-name="scriptWorkingDirectory">
                <description>The absolute path of the working directory for the program to be run. VMware recommends explicitly setting the working directory for the program to be run. If this value is unset or is an empty string, the behavior depends on the guest operating system. For Linux guest operating systems, if this value is unset or is an empty string, the working directory will be the home directory of the user associated with the guest authentication. For other guest operating systems, if this value is unset, the behavior is unspecified. </description>
            </bind>
            <bind name="environment" type="Array/Any" export-name="NULL">
                <description>An array of environment variables, specified in the guest OS notation (eg PATH=c:\bin;c:\windows\system32 or LD_LIBRARY_PATH=/usr/lib:/lib), to be set for the program being run. Note that these are not additions to the default environment variables; they define the complete set available to the program. If none are specified the values are guest dependent. </description>
            </bind>
        </in-binding>
        <out-binding>
            <bind name="result" type="number" export-name="scriptPid">
                <description>The pid of the program started.</description>
            </bind>
        </out-binding>
        <description>Starts a program in the guest operating system.
A process started this way can have its status queried with this API. When the process completes, its exit code and end time will be available for 5 minutes after completion.</description>
        <position y="337.2272727272727" x="1804.5"/>
    </workflow-item>
    <workflow-item name="item34" out-name="item23" type="link" linked-workflow-id="C9808080808080808080808080808080DA80808001322751030482b80adf61e7c" comparator="0">
        <display-name>Create Temp FIle</display-name>
        <in-binding>
            <bind name="vmUsername" type="string" export-name="username">
                <description>Username for the virtual machine</description>
            </bind>
            <bind name="vmPassword" type="SecureString" export-name="password">
                <description>Password for the virtual machine</description>
            </bind>
            <bind name="vm" type="VC:VirtualMachine" export-name="vm">
                <description>Virtual machine</description>
            </bind>
            <bind name="dirPath" type="string" export-name="guestTempDirectory">
                <description>The complete path to the directory in which to create the new file. If unset or an empty string, a guest-specific location will be used.</description>
            </bind>
            <bind name="prefix" type="string" export-name="scriptOutputPrefix">
                <description>The prefix to be given to the new temporary file</description>
            </bind>
            <bind name="suffix" type="string" export-name="powershellSuffix">
                <description>The suffix to be given to the new temporary file</description>
            </bind>
        </in-binding>
        <out-binding>
            <bind name="result" type="string" export-name="powershellScriptGuestPath">
                <description>The absolute path of the temporary file that is created.</description>
            </bind>
        </out-binding>
        <description>Create a temporary powershell file in guest</description>
        <position y="155.4090909090909" x="684.5"/>
    </workflow-item>
    <workflow-item name="item35" out-name="item32" type="link" linked-workflow-id="C78080808080808080808080808080809480808001322751030482b80adf61e7c" comparator="0">
        <display-name>Copy file from vCO to guest</display-name>
        <in-binding>
            <bind name="vmUsername" type="string" export-name="username">
                <description>Username for the virtual machine</description>
            </bind>
            <bind name="vmPassword" type="SecureString" export-name="password">
                <description>Password for the virtual machine</description>
            </bind>
            <bind name="vm" type="VC:VirtualMachine" export-name="vm">
                <description>Virtual machine</description>
            </bind>
            <bind name="vcoPath" type="string" export-name="powershellScriptVcoPath">
                <description>Path on vCO server</description>
            </bind>
            <bind name="guestFilePath" type="string" export-name="powershellScriptGuestPath">
                <description>Guest file path</description>
            </bind>
            <bind name="overwrite" type="boolean" export-name="overwrite">
                <description>Overwrite file if exists</description>
            </bind>
        </in-binding>
        <out-binding>
            <bind name="result" type="boolean" export-name="vcoCopiedFileResult">
                <description>Set to true if copy operation was successful</description>
            </bind>
        </out-binding>
        <description>Copies the specified file from the vCO server to the guest file system.</description>
        <position y="155.4090909090909" x="1104.5"/>
    </workflow-item>
    <workflow-item name="item36" out-name="item35" type="task" comparator="0">
        <display-name>Save script to vCO</display-name>
        <script encoded="false">powershellScriptVcoPath = System.getTempDirectory() + "/" + System.nextUUID();

var fileWriter = new FileWriter(powershellScriptVcoPath);
fileWriter.open();
fileWriter.clean();
fileWriter.write(powershellScript);
fileWriter.close();</script>
        <in-binding>
            <bind name="powershellScript" type="string" export-name="powershellScript"/>
        </in-binding>
        <out-binding>
            <bind name="powershellScriptVcoPath" type="string" export-name="powershellScriptVcoPath"/>
        </out-binding>
        <position y="155.4090909090909" x="964.5"/>
    </workflow-item>
    <workflow-item name="item8" type="end" end-mode="0" comparator="0">
        <position y="327.2272727272727" x="1284.5"/>
    </workflow-item>
    <workflow-item name="item38" out-name="item31" type="task" prototype-id="system-log" interaction="l" comparator="0">
        <display-name>System log</display-name>
        <script encoded="false">//Auto-generated script
System.log(text);
</script>
        <in-binding>
            <bind name="text" type="String" export-name="errorCode">
                <description>The text to log</description>
            </bind>
        </in-binding>
        <out-binding/>
        <description>Log the input text to the console log with level 'log'</description>
        <position y="337.2272727272727" x="1524.5"/>
    </workflow-item>
    <workflow-item name="item40" out-name="item11" catch-name="item5" throw-bind-name="errorCode" type="task" comparator="0">
        <display-name>Error Checking</display-name>
        <script encoded="false">if (errorCode.indexOf("Failed to authenticate") &gt; -1) {
	var message = "Failed to authenticate with the guest operating system, this workflow will now terminate.";
	System.error(message);
	Server.error(message);
	throw message;
}

else if (errorCode.indexOf("The guest operating agent could not be contacted") &gt; -1) { var message = "Retrieving the process list failed, cycling back into the loop"; }
else { var message = "Unknown error. The error handler passed the following output: "+errorCode; }
System.warn(message);
Server.warn(message);
</script>
        <in-binding>
            <bind name="errorCode" type="string" export-name="errorCode"/>
        </in-binding>
        <out-binding/>
        <position y="91.77272727272727" x="1524.5"/>
    </workflow-item>
    <workflow-item name="item41" out-name="item17" catch-name="item33" throw-bind-name="errorCode" type="link" linked-workflow-id="C9808080808080808080808080808080CA80808001322751030482b80adf61e7c" comparator="0">
        <display-name>Make Temp Dir in VM</display-name>
        <in-binding>
            <bind name="vmUsername" type="string" export-name="username">
                <description>Username for the virtual machine</description>
            </bind>
            <bind name="vmPassword" type="SecureString" export-name="password">
                <description>Password for the virtual machine</description>
            </bind>
            <bind name="vm" type="VC:VirtualMachine" export-name="vm">
                <description>Virtual machine</description>
            </bind>
            <bind name="dirPath" type="string" export-name="NULL">
                <description>The complete path to the directory in which to create the new directory. If unset or an empty string, a guest-specific location will be used.</description>
            </bind>
            <bind name="prefix" type="string" export-name="NULL">
                <description>The prefix to be given to the new temporary directory</description>
            </bind>
            <bind name="suffix" type="string" export-name="NULL">
                <description>The suffix to be given to the new temporary directory</description>
            </bind>
        </in-binding>
        <out-binding>
            <bind name="result" type="string" export-name="guestTempDirectory">
                <description>The absolute path of the temporary directory that is created.</description>
            </bind>
        </out-binding>
        <description>Create a temporary directory in a guest virtual machine.</description>
        <position y="28.136363636363633" x="264.5"/>
    </workflow-item>
    <workflow-item name="item31" out-name="item8" catch-name="item9" throw-bind-name="errorCode" type="link" linked-workflow-id="C98080808080808080808080808080808280808001322751030482b80adf61e7c" comparator="0">
        <display-name>Delete Directory</display-name>
        <in-binding>
            <bind name="vmUsername" type="string" export-name="username">
                <description>Username for the virtual machine</description>
            </bind>
            <bind name="vmPassword" type="SecureString" export-name="password">
                <description>Password for the virtual machine</description>
            </bind>
            <bind name="vm" type="VC:VirtualMachine" export-name="vm">
                <description>Virtual machine</description>
            </bind>
            <bind name="dirPath" type="string" export-name="guestTempDirectory">
                <description>Guest path</description>
            </bind>
            <bind name="recirsive" type="boolean" export-name="recirsive">
                <description>Delete directory content recursively</description>
            </bind>
        </in-binding>
        <out-binding>
            <bind name="result" type="boolean" export-name="NULL">
                <description>Set to true if directory was created successfully</description>
            </bind>
        </out-binding>
        <description>Delete a directory in a guest virtual machine.</description>
        <position y="273.59090909090907" x="1384.5"/>
    </workflow-item>
    <workflow-item name="item9" out-name="item8" type="task" prototype-id="system-log" interaction="l" comparator="0">
        <display-name>System log</display-name>
        <script encoded="false">//Auto-generated script
System.log(text);
</script>
        <in-binding>
            <bind name="text" type="String" export-name="errorCode">
                <description>The text to log</description>
            </bind>
        </in-binding>
        <out-binding/>
        <description>Log the input text to the console log with level 'log'</description>
        <position y="337.2272727272727" x="1385.0"/>
    </workflow-item>
    <workflow-item name="item37" out-name="item1" type="link" linked-workflow-id="7ced6eda-298e-4d62-9811-7cb9c61f382b" comparator="0">
        <display-name>Improved Sleep</display-name>
        <in-binding>
            <bind name="delay" type="number" export-name="delay">
                <description>Time to wait (seconds)</description>
            </bind>
        </in-binding>
        <out-binding/>
        <position y="91.77272727272727" x="1665.0"/>
    </workflow-item>
    <presentation>
        <desc>Run Script in Guest OS</desc>
        <p-step>
            <title>Run a script</title>
            <p-group>
                <title>Virtual Machine Information</title>
                <p-param name="vm">
                    <desc>Virtual Machine</desc>
                    <p-qual kind="static" name="mandatory" type="boolean">false</p-qual>
                </p-param>
                <p-param name="username">
                    <desc>Guest OS Username</desc>
                    <p-qual kind="static" name="mandatory" type="boolean">true</p-qual>
                </p-param>
                <p-param name="password">
                    <desc>Guest OS Password</desc>
                    <p-qual kind="static" name="mandatory" type="boolean">false</p-qual>
                </p-param>
            </p-group>
            <p-group>
                <title>Script</title>
                <p-param name="scriptType">
                    <desc>Script Type (bash, batch, powershell)</desc>
                    <p-qual kind="static" name="mandatory" type="boolean">true</p-qual>
                    <p-qual kind="static" name="genericEnumeration" type="Array/string">#{#string#batch#;#string#bash#;#string#powershell#}#</p-qual>
                </p-param>
                <p-param name="script">
                    <desc>Script</desc>
                    <p-qual kind="static" name="textInput" type="void">__NULL__</p-qual>
                    <p-qual kind="static" name="mandatory" type="boolean">true</p-qual>
                </p-param>
                <p-param name="scriptTimeout">
                    <desc>Timeout for the running script (in second)</desc>
                    <p-qual kind="static" name="minNumberValue" type="Number">5.0</p-qual>
                    <p-qual kind="static" name="defaultValue" type="number">120.0</p-qual>
                </p-param>
                <p-param name="scriptRefreshTime">
                    <desc>(default) Time (in seconds) where a check of script status occurs</desc>
                </p-param>
                <p-param name="interactiveSession">
                    <desc>Script context interactivity</desc>
                    <p-qual kind="static" name="defaultValue" type="boolean">__NULL__</p-qual>
                </p-param>
                <p-param name="scriptWorkingDirectory">
                    <desc>(optional) Script working directory in the guest</desc>
                </p-param>
            </p-group>
        </p-step>
    </presentation>
    <workflow-note x="120.0" y="18.181818181818173" w="1400.0" h="172.72727272727272" color="b0ebb0ff">
        <description>Script Preparation</description>
    </workflow-note>
    <workflow-note x="1820.0" y="18.181818181818187" w="240.0" h="227.27272727272725" color="ebb0b0ff">
        <description>Manage timeout</description>
    </workflow-note>
    <workflow-note x="1660.0" y="18.181818181818187" w="140.0" h="227.27272727272725" color="b0ebebff">
        <description>Script Monitoring</description>
    </workflow-note>
    <workflow-note x="1380.0" y="254.54545454545453" w="260.0" h="118.18181818181817" color="ebebebff">
        <description>Cleanup</description>
    </workflow-note>
    <workflow-note x="1660.0" y="254.54545454545453" w="400.0" h="118.18181818181817" color="ebb0ebff">
        <description>Retrieve output</description>
    </workflow-note>
</ns2:workflow>
